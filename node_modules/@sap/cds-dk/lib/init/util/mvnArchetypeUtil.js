
const { MAVEN_ARCHETYPE_VERSION, OPTION_JAVA_MVN,
    OPTION_JAVA_PACKAGE, OPTION_SAMPLES, REGEX_JAVA_PACKAGE, OPTION_HANA } = require('../constants');

class MvnArchetypeUtil {

    _scanMvnParams(mvnParams, params) {
        // need to create new regex every call since a constant
        // would keep the match state

        var quoteRegex = /([\w-]+)=(\w+|\[([\w,]+)\])/g;
        // captures a=1         => a:1
        //          -Da=[x,y,z] => -Da:x,y,z (Maven specific)
        //          a=[x,y,z]   => a:x,y,z

        let match = quoteRegex.exec(mvnParams);
        while (match != null) {
            const key = (match[1].startsWith('-D') ? match[1] : `-D${match[1]}`);
            params.set(key, match[3] || match[2]);
            match = quoteRegex.exec(mvnParams);
        }
    }

    _finalize(params) {
        // `-DcdsVersion=3.0.0`,
        params.set(`-Dstyle.color`, `always`);

        params.set('-B');

        if (process.env.DEBUG) {
            params.set('-X');
        }

        return Array.from(params, (e) => {
            let result = e[0];
            // ignore if null/undefined but write "false" and "0"
            if (e[1] != undefined) {
                result = result + `=${e[1]}`;
            }
            return result;
        });
    }

    getAddSamplesCmdArgs(options) {
        const params = new Map();

        params.set(`com.sap.cds:cds-maven-plugin:${MAVEN_ARCHETYPE_VERSION}:addSample`);

        if (options[OPTION_JAVA_MVN]) {
            this._scanMvnParams(options[OPTION_JAVA_MVN], params);
        }

        if (options.force) {
            params.set(`-Doverwrite`, true);
        }

        return this._finalize(params);
    }

    getAddTestsCmdArgs(options) {
        const params = new Map();

        params.set(`com.sap.cds:cds-maven-plugin:${MAVEN_ARCHETYPE_VERSION}:addIntegrationTest`);

        if (options[OPTION_JAVA_MVN]) {
            this._scanMvnParams(options[OPTION_JAVA_MVN], params);
        }

        if (options.force) {
            params.set(`-Doverwrite`, true);
        }

        return this._finalize(params);
    }

    getAddHanaCmdArgs(options) {
        const params = new Map();

        params.set(`com.sap.cds:cds-maven-plugin:${MAVEN_ARCHETYPE_VERSION}:addTargetPlatform`);
        params.set(`-DtargetPlatform`, `cloudfoundry`);

        if (options[OPTION_JAVA_MVN]) {
            this._scanMvnParams(options[OPTION_JAVA_MVN], params);
        }

        return this._finalize(params);
    }

    getGenerateCmdArgs(projectName, options) {
        const params = new Map();

        params.set(`archetype:generate`);
        params.set(`-DarchetypeArtifactId`, `cds-services-archetype`);
        params.set(`-DarchetypeGroupId`, `com.sap.cds`);
        params.set(`-DarchetypeVersion`, MAVEN_ARCHETYPE_VERSION);
        params.set(`-DartifactId`, projectName);
        params.set(`-DgroupId`, `customer`);

        const hasHana = !!(options.add && options.add.has(OPTION_HANA));
        if (hasHana) {
            params.set(`-DtargetPlatform`, `cloudfoundry`);
        }

        const hasSamples = !!(options.add && options.add.has(OPTION_SAMPLES));
        params.set(`-DincludeModel`, hasSamples);
        params.set(`-DincludeIntegrationTest`, hasSamples);

        if (options[OPTION_JAVA_PACKAGE]) {
            params.set(`-Dpackage`, options[OPTION_JAVA_PACKAGE]);
        }

        if (options[OPTION_JAVA_MVN]) {
            this._scanMvnParams(options[OPTION_JAVA_MVN], params);
        }

        if (!options.force) {
            const finalPackage = params.get('-Dpackage');
            if (finalPackage) {
                if (!finalPackage.match(REGEX_JAVA_PACKAGE)) {
                    throw new Error(`Package '${finalPackage}' is an invalid Java package. Use --force to use anyway.`);
                }
            } else {
                const artifactId = params.get('-DartifactId');
                if (!artifactId.match(REGEX_JAVA_PACKAGE)) {
                    throw new Error(`ArtifactId '${artifactId}' is an invalid Java package. Use --force to use anyway.`);
                }
            }
        }

        return this._finalize(params);
    }
}

module.exports = new MvnArchetypeUtil();
