const path = require('path')
const fs = require('@sap/cds-foss')('fs-extra')
const BuildTaskEngine = require('./buildTaskEngine')
const BuildTaskFactory = require('./buildTaskFactory')
const BuildTaskHandler = require('./buildTaskHandler')
const { BuildError, BuildRuntimeError } = require('./util')
const {BUILD_MODE_INPLACE} = require ('./constants')

module.exports = { build, BuildTaskFactory, BuildTaskEngine, BuildTaskHandler, BuildError, BuildRuntimeError }

/**
 * New modular build.
 *
 * @param {object} options - commmand options as defined by build command.
 * @param {object} _env - for testing purposes only, will be removed.
 */
async function build(options = {}, _env = null /* for unit tests only: */) {
    const logger = options.logger || global.console
    const projectPath = path.resolve(options.project || '.')

    if (!fs.lstatSync(projectPath).isDirectory()) {
        return Promise.reject(`Project [${projectPath}] does not exist`)
    }

    const cds = require('..').in(projectPath)
    if (_env) {
        // REVISIT: please avoid using internal APIs
        cds.env = cds.env._merge_with(_env)
    }

    if (cds.env.features.snapi === 'runtime-only') cds.env.features.snapi = false

    const buildOptions = _mergeOptions({ root: projectPath }, options)

    // Webide Fullstack compatibility mode
    if (cds.env.build.mode === BUILD_MODE_INPLACE) {
        cds.env.build.target = "."
    }
    let tasks = await new BuildTaskFactory(logger, cds).getTasks(buildOptions)
    return new BuildTaskEngine(logger, cds).processTasks(tasks, buildOptions)
}

function _mergeOptions(buildOptions, options) {
    buildOptions["log-level"] = options["log-level"]
    buildOptions.cli = options.cli
    buildOptions.cmdOptions = options
    return buildOptions
}
